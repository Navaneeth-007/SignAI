<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignAI - Video Call</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="call.css">
</head>
<body>
    <!-- Call Setup Modal -->
    <div class="setup-modal" id="setupModal">
        <div class="setup-content">
            <h2>Call Setup</h2>
            <p>Please select your role for this call:</p>
            
            <div class="role-selection">
                <div class="role-option">
                    <input type="radio" id="normalUser" name="role" value="normal">
                    <label for="normalUser">
                        <h3>Regular User</h3>
                        <p>I don't need sign language interpretation</p>
                    </label>
                </div>

                <div class="role-option">
                    <input type="radio" id="accessibilityUser" name="role" value="accessibility">
                    <label for="accessibilityUser">
                        <h3>Accessibility User</h3>
                        <p>I need sign language interpretation</p>
                    </label>
                </div>
            </div>

            <button id="startCallBtn" class="start-call-btn" disabled>Start Call</button>
        </div>
    </div>

    <div class="call-container" style="display: none;">
        <nav class="call-nav">
            <div class="nav-logo">
                <img src="../assets/logo.png" alt="SignAI Logo">
                <span>SignAI Call</span>
            </div>
            <div class="call-info">
                <span class="role-indicator"></span>
            </div>
            <button class="end-call-btn" onclick="window.location.href='../home/home.html'">End Call</button>
        </nav>

        <div class="video-container">
            <div class="video-grid">
                <div class="video-wrapper local-video">
                    <video id="localVideo" autoplay playsinline muted></video>
                    <div class="video-label">You</div>
                </div>
                <div class="video-wrapper remote-video">
                    <video id="remoteVideo" autoplay playsinline></video>
                    <div class="video-label">Remote User</div>
                </div>
            </div>

            <div id="aiOutput" class="ai-output">
                <div class="interpretation-text"></div>
                <audio id="interpretationAudio" autoplay></audio>
            </div>

            <div class="controls">
                <button id="muteBtn" class="control-btn">
                    <img src="../assets/mic.svg" alt="Mute" id="muteIcon">
                </button>
                <button id="videoBtn" class="control-btn">
                    <img src="../assets/video.svg" alt="Video" id="videoIcon">
                </button>
                <button id="endCallBtn" class="control-btn end">
                    <img src="../assets/end-call.svg" alt="End Call">
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB9xPOobDKznWSxkWxTngBarSEOqdjRr74",
            authDomain: "signai-ea820.firebaseapp.com",
            projectId: "signai-ea820",
            storageBucket: "signai-ea820.firebasestorage.app",
            messagingSenderId: "88913376198",
            appId: "1:88913376198:web:bd13282673a2a8415fb8c7",
            measurementId: "G-7W3MJTFNSR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let localStream;
        let remoteStream;
        let peerConnection;
        let callDoc;
        let callId;
        let userRole;
        let websocket;
        let mediaRecorder;
        let audioChunks = [];
        let isProcessingFrame = false;

        const servers = {
            iceServers: [
                {
                    urls: ['stun:stun1.l.google.com:19302', 'stun:stun2.l.google.com:19302'],
                },
            ],
        };

        // Get DOM elements
        const setupModal = document.getElementById('setupModal');
        const startCallBtn = document.getElementById('startCallBtn');
        const callContainer = document.querySelector('.call-container');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const muteBtn = document.getElementById('muteBtn');
        const videoBtn = document.getElementById('videoBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const roleIndicator = document.querySelector('.role-indicator');
        const aiOutput = document.getElementById('aiOutput');
        const interpretationText = aiOutput.querySelector('.interpretation-text');
        const interpretationAudio = document.getElementById('interpretationAudio');

        // Connect to WebSocket server with retry
        function connectWebSocket() {
            let retryCount = 0;
            const maxRetries = 3;
            const retryDelay = 2000; // 2 seconds
            
            function connect() {
                try {
                    console.log('Attempting to connect to WebSocket server...');
                    websocket = new WebSocket('ws://localhost:8765');
                    
                    websocket.onopen = () => {
                        console.log('Connected to WebSocket server');
                        retryCount = 0;
                        // Send initial role
                        websocket.send(JSON.stringify({ role: userRole }));
                    };
                    
                    websocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        console.log('Received message:', data);
                        
                        if (data.type === 'connection_status') {
                            if (data.status === 'connected') {
                                console.log(`Connected as ${data.role} user`);
                                // Start processing based on role
                                if (userRole === 'accessibility') {
                                    startVideoProcessing();
                                } else {
                                    startAudioProcessing();
                                }
                            }
                        } else if (data.type === 'interpretation') {
                            // Display text interpretation
                            interpretationText.textContent = data.text;
                            aiOutput.classList.add('active');
                            
                            // Play audio interpretation
                            if (data.audio) {
                                interpretationAudio.src = `data:audio/mp3;base64,${data.audio}`;
                            }
                        } else if (data.type === 'error') {
                            console.error('Server error:', data.message);
                            alert(`Error: ${data.message}`);
                        }
                    };
                    
                    websocket.onerror = (error) => {
                        console.error('WebSocket error:', error);
                    };
                    
                    websocket.onclose = (event) => {
                        console.log('WebSocket connection closed:', event.code, event.reason);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Retrying connection (${retryCount}/${maxRetries})...`);
                            setTimeout(connect, retryDelay);
                        } else {
                            console.error('Failed to connect to WebSocket server after multiple attempts');
                            alert('Could not connect to the interpretation server. Please try refreshing the page.');
                        }
                    };
                } catch (error) {
                    console.error('Error creating WebSocket connection:', error);
                    if (retryCount < maxRetries) {
                        retryCount++;
                        console.log(`Retrying connection (${retryCount}/${maxRetries})...`);
                        setTimeout(connect, retryDelay);
                    }
                }
            }
            
            connect();
        }

        // Process video frames for sign language interpretation
        function startVideoProcessing() {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            function processFrame() {
                if (!isProcessingFrame && websocket.readyState === WebSocket.OPEN) {
                    isProcessingFrame = true;
                    
                    // Set canvas dimensions to match video
                    canvas.width = localVideo.videoWidth;
                    canvas.height = localVideo.videoHeight;
                    
                    // Draw current frame to canvas
                    context.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
                    
                    // Convert to base64 and send to server
                    const frameData = canvas.toDataURL('image/jpeg', 0.8);
                    websocket.send(JSON.stringify({
                        type: 'video_frame',
                        data: frameData
                    }));
                    
                    isProcessingFrame = false;
                }
                
                // Process next frame
                requestAnimationFrame(processFrame);
            }
            
            processFrame();
        }

        // Process audio for speech-to-text
        function startAudioProcessing() {
            const audioTrack = localStream.getAudioTracks()[0];
            const audioStream = new MediaStream([audioTrack]);
            
            mediaRecorder = new MediaRecorder(audioStream);
            
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = [];
                
                // Convert blob to base64
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Audio = reader.result.split(',')[1];
                    websocket.send(JSON.stringify({
                        type: 'audio',
                        data: base64Audio
                    }));
                };
                reader.readAsDataURL(audioBlob);
                
                // Start new recording
                mediaRecorder.start(1000);
            };
            
            mediaRecorder.start(1000);
        }

        // Handle role selection
        document.querySelectorAll('input[name="role"]').forEach(radio => {
            radio.addEventListener('change', () => {
                userRole = radio.value;
                startCallBtn.disabled = false;
            });
        });

        // Initialize call
        async function initCall() {
            const targetUserId = sessionStorage.getItem('callUserId');
            if (!targetUserId) {
                alert('No user selected for call');
                window.location.href = '../home/home.html';
                return;
            }

            try {
                // Get local stream
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;

                // Create peer connection
                peerConnection = new RTCPeerConnection(servers);

                // Add local tracks to peer connection
                localStream.getTracks().forEach((track) => {
                    peerConnection.addTrack(track, localStream);
                });

                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    console.log('Received remote track:', event.track.kind);
                    if (event.track.kind === 'video') {
                        if (!remoteVideo.srcObject) {
                            remoteVideo.srcObject = new MediaStream();
                        }
                        remoteVideo.srcObject.addTrack(event.track);
                        console.log('Remote video track added');
                    }
                };

                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        // Serialize the ICE candidate before storing
                        const serializedCandidate = {
                            sdpMLineIndex: event.candidate.sdpMLineIndex,
                            sdpMid: event.candidate.sdpMid,
                            candidate: event.candidate.candidate
                        };
                        updateDoc(callDoc, {
                            iceCandidates: arrayUnion(serializedCandidate)
                        });
                    }
                };

                // Create call document with role
                const callsRef = collection(db, 'calls');
                callDoc = await addDoc(callsRef, {
                    initiator: auth.currentUser.uid,
                    target: targetUserId,
                    status: 'pending',
                    initiatorRole: userRole
                });
                callId = callDoc.id;

                // Update UI with role
                roleIndicator.textContent = `Role: ${userRole === 'accessibility' ? 'Accessibility User' : 'Regular User'}`;

                // Listen for remote ICE candidates
                onSnapshot(doc(db, 'calls', callId), async (snapshot) => {
                    const data = snapshot.data();
                    if (data?.answer) {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                    }
                    if (data?.iceCandidates) {
                        for (const candidate of data.iceCandidates) {
                            try {
                                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                            } catch (e) {
                                console.warn('Error adding ICE candidate:', e);
                            }
                        }
                    }
                });

                // Create and set local offer
                const offerDescription = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offerDescription);

                await updateDoc(callDoc, {
                    offer: {
                        type: offerDescription.type,
                        sdp: offerDescription.sdp
                    }
                });

                // Hide setup modal and show call container
                setupModal.style.display = 'none';
                callContainer.style.display = 'flex';

                // Connect to WebSocket server for interpretations
                connectWebSocket();

            } catch (error) {
                console.error('Error initializing call:', error);
                alert('Error starting call. Please try again.');
            }
        }

        // Start call button handler
        startCallBtn.addEventListener('click', initCall);

        // Handle mute/unmute
        muteBtn.addEventListener('click', () => {
            const audioTrack = localStream.getAudioTracks()[0];
            audioTrack.enabled = !audioTrack.enabled;
            muteBtn.classList.toggle('muted');
        });

        // Handle video on/off
        videoBtn.addEventListener('click', () => {
            const videoTrack = localStream.getVideoTracks()[0];
            videoTrack.enabled = !videoTrack.enabled;
            videoBtn.classList.toggle('video-off');
        });

        // Handle end call
        endCallBtn.addEventListener('click', async () => {
            if (callId) {
                await deleteDoc(doc(db, 'calls', callId));
            }
            if (websocket) {
                websocket.close();
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            localStream?.getTracks().forEach(track => track.stop());
            window.location.href = '../home/home.html';
        });

        // Check authentication and show setup modal
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '../login/login.html';
                return;
            }
        });

        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (callId) {
                await deleteDoc(doc(db, 'calls', callId));
            }
            if (websocket) {
                websocket.close();
            }
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            localStream?.getTracks().forEach(track => track.stop());
        });
    </script>
</body>
</html> 