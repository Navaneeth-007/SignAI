<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SignAI - Video Call</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“ž</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="call.css">
</head>
<body>
    <!-- Role Selection Modal -->
    <div class="modal" id="roleModal">
        <div class="modal-content">
            <h2>Select Your Role</h2>
            <div class="role-options">
                <label class="role-option">
                    <input type="radio" name="role" value="regular">
                    <div class="role-details">
                        <h3>Regular User</h3>
                        <p>I don't need sign language interpretation</p>
                    </div>
                </label>
                <label class="role-option">
                    <input type="radio" name="role" value="accessibility">
                    <div class="role-details">
                        <h3>Accessibility User</h3>
                        <p>I need sign language interpretation</p>
                    </div>
                </label>
            </div>
            <button id="startCallBtn" class="start-button" disabled>Start Call</button>
        </div>
    </div>

    <!-- Main Call Interface (Initially Hidden) -->
    <div class="container" style="display: none;">
        <div class="video-grid">
            <div class="video-wrapper remote">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="user-label">Other Person</div>
            </div>
            <div class="video-wrapper local">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="user-label">You</div>
            </div>
        </div>

        <div class="ai-output">
            <div class="interpretation-text"></div>
            <audio id="interpretationAudio" autoplay></audio>
        </div>

        <div class="controls">
            <button id="endCall" class="control-button">End Call</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
        import CallConnection from './socket.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB9xPOobDKznWSxkWxTngBarSEOqdjRr74",
            authDomain: "signai-ea820.firebaseapp.com",
            projectId: "signai-ea820",
            storageBucket: "signai-ea820.firebasestorage.app",
            messagingSenderId: "88913376198",
            appId: "1:88913376198:web:bd13282673a2a8415fb8c7",
            measurementId: "G-7W3MJTFNSR"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let callConnection = null;

        // Get target user ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('targetId');

        if (!targetUserId) {
            alert('No target user selected. Redirecting to home page...');
            window.location.href = '../home/home.html';
            throw new Error('No target user ID provided');
        }

        // Handle role selection
        const roleModal = document.getElementById('roleModal');
        const container = document.querySelector('.container');
        const startCallBtn = document.getElementById('startCallBtn');
        let selectedRole = null;

        // Check authentication first
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '../login/login.html';
                return;
            }
            
            // Only setup role selection after confirming authentication
            document.querySelectorAll('input[name="role"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedRole = e.target.value;
                    startCallBtn.disabled = false;
                });
            });

            startCallBtn.addEventListener('click', async () => {
                if (!selectedRole) return;
                
                roleModal.style.display = 'none';
                container.style.display = 'flex';
                
                const localVideo = document.getElementById('localVideo');
                const remoteVideo = document.getElementById('remoteVideo');
                const aiOutput = document.querySelector('.ai-output');

                try {
                    callConnection = new CallConnection(db, auth, localVideo, remoteVideo, aiOutput);
                    await callConnection.initializeCall(selectedRole, targetUserId);
                } catch (error) {
                    console.error('Failed to initialize call:', error);
                    alert('Failed to initialize call. Please try again.');
                    window.location.href = '../home/home.html';
                }
            });
        });

        // Handle end call button
        document.getElementById('endCall').addEventListener('click', async () => {
            if (callConnection) {
                await callConnection.cleanup();
            }
            window.location.href = '../home/home.html';
        });

        // Handle page unload
        window.addEventListener('beforeunload', async () => {
            if (callConnection) {
                await callConnection.cleanup();
            }
        });
    </script>
</body>
</html> 